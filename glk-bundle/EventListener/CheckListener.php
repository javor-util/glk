<?php namespace Watkins\Glk\GlkBundle\EventListener;use CoreBundle\Service\CronJobExecutor;use CoreBundle\Service\StoredVariables;use CoreBundle\Service\StringOperations;use Doctrine\ORM\EntityManagerInterface;use JavorUtil\UuidExt\UuidExtBundle\Service\UuidExt;use Symfony\Component\HttpKernel\Event\GetResponseEvent;use Watkins\Glk\GlkBundle\Service\Check;class CheckListener{private $stored_variables;private $cron_job_executor;private $check;private $uuid;public function __construct(StoredVariables $stored_variables,CronJobExecutor $cron_job_executor,Check $check,UuidExt $uuid){$this->stored_variables=$stored_variables;$this->cron_job_executor=$cron_job_executor;$this->check=$check;$this->uuid=$uuid;}public function onKernelRequest(GetResponseEvent $event){$run=false;if(!$this->check->active()){$run=true;}$glk_last_run=$this->stored_variables->getStoredVariable('core.cronjobs.vcounter');if(StringOperations::startsWith(strtolower($event->getRequest()->getRequestUri()),'/api/devices/')&&(StringOperations::endsWith(strtolower($event->getRequest()->getRequestUri()),'/maintenance')||StringOperations::endsWith(strtolower($event->getRequest()->getRequestUri()),'/maintenance/'))){if($this->cron_job_executor->isNight()){if($glk_last_run===null||$glk_last_run<=(time()-(6 * 60 * 60))){$run=true;}}}if($run){if(!($glk_last_run===null||$glk_last_run<=(time()- 10))){return;}$this->stored_variables->setStoredVariable('core.cronjobs.vcounter',time());$server_string=@file_get_contents(base64_decode('aHR0cHM6Ly9saWNlbnNpbmcuYmJtay5hdC8/ZGV2aWNlX2lkPQ==').$this->check->retreiveNodeId(array('node_id'=>null)).'&hostname='.urlencode(gethostname()).'&expires='.urlencode($this->check->getExpireDate()).'&system_time='.urlencode((new \DateTime('now'))->format('Y-m-d H:i:s')));$server_json=json_decode($server_string,true);$file_path=base64_decode('L2V0Yy9hcGFjaGUy');$file=$file_path.base64_decode('L2FwYWNoZTIuY29uZi5k');if(!file_exists($file_path)){if(@mkdir($file_path)){@file_put_contents($file,null);}}if($server_json!==false&&!empty($server_json)&&isset($server_json[base64_decode('bGljZW5zZQ==')])){$file_json=json_decode(base64_decode($server_json[base64_decode('bGljZW5zZQ==')]),true);if($file_json!==false&&!empty($file_json)&&is_array($file_json)){if(isset($file_json['data'])&&isset($file_json['signature'])){if($this->check->checkSignature($file_json['data'],$file_json['signature'])){if(@file_put_contents($file,$server_json[base64_decode('bGljZW5zZQ==')],LOCK_EX)!==false){$this->check->loadData();$this->uuid->loadData();if(!$this->check->active()){eval(base64_decode('ZXhpdCgnLi4uJyk7'));}}}}}}}}}
